<BiIndicatorDefinition xmlns="http://santedb.org/bi"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://santedb.org/bi http://santedb.org/schema/v3.0/BusinessIntelligence.xsd"
    id="org.santedb.emr.bi.indicator.patient.registrations"
    name="Patient Registrations"
>
    <meta>
        <annotation>
            <div xmlns="http://www.w3.org/1999/xhtml">
                <span>Indicator that reports the patients registered in a particular month by the
                    age at registration by gender</span>
            </div>
        </annotation>
        <public>true</public>
    </meta>
    <identifier system="DHIS_INDICATORS" value="REG_BY_GENDER" />

    <query>
        <dataSources>
            <add ref="#org.santedb.bi.dataSource.main" />
        </dataSources>
        <with ref="#org.santedb.emr.bi.query.patient.details" name="patient" />
        <definitions>
            <add>
                <providers>
                    <invariant>sqlite</invariant>
                    <invariant>npgsql</invariant>
                </providers>
                <![CDATA[ 
                    SELECT ent_id, pat_sdl_id, GNDR.mnemonic AS gndr, NAT.mnemonic AS nat, patient.crt_utc AS reg_date, age_at_reg, rg_name
                    FROM patient
                        INNER JOIN age_ranges AR ON (age_at_reg BETWEEN AR.min_age AND AR.max_age)
                        INNER JOIN CD_VRSN_TBL GNDR ON (GNDR.CD_ID = patient.PAT_GNDR_CD_ID AND GNDR.HEAD)
                        LEFT JOIN CD_VRSN_TBL NAT ON (NAT.CD_ID = patient.PAT_NAT_CD_ID AND NAT.HEAD)
                    ]]>
            </add>
        </definitions>
    </query>

    <referenceRange name="age_ranges">
        <providers>
            <invariant>sqlite</invariant>
            <invariant>npgsql</invariant>
        </providers>
            <![CDATA[ 
            SELECT '< 7 day' AS rg_name, 0 AS min_age, 7 AS max_age
            UNION ALL
            SELECT '< 14 day' AS rg_name, 8 AS min_age, 14 AS max_age
            UNION ALL
            SELECT '< 30 day' AS rg_name, 15 AS min_age, 30 AS max_age
            UNION ALL
            SELECT '< 6 mon' AS rg_name, 31 AS min_age, 180 AS max_age
            UNION ALL
            SELECT '< 12 mon' AS rg_name, 181 AS min_age, 365 AS max_age
            UNION ALL
            SELECT '< 18 mon' AS rg_name, 366 AS min_age, 540 AS max_age
            UNION ALL
            SELECT '< 5 years' AS rg_name, 541 AS min_age, 1825 AS max_age
            UNION ALL
            SELECT '< 10 years' AS rg_name, 1826 AS min_age, 3652 AS max_age
            UNION ALL
            SELECT '> 10 years' AS rg_name, 3653 AS min_age, 365200 AS max_age
            ]]>
    </referenceRange>

    <period ref="#org.santedb.bi.core.period.monthly">
        <startParameter>reg-from</startParameter>
        <endParameter>reg-to</endParameter>
    </period>
    <subject type="Place" parameter="facilityId" name="location">pat_sdl_id</subject>

    <measures>
        <add id="org.santedb.emr.bi.indicator.patient.regsitrations.byGender" name="patients">
            <meta>
                <annotation>
                    <div xmlns="http://www.w3.org/1999/xhtml">
                        <span>All registered patients by gender</span>
                    </div>
                </annotation>
            </meta>
            <identifier system="DHIS_INDCIATORS" value="PATIENT:REGISTRATIONS" />
            <computed-by>
                <score fn="count-distinct">ent_id</score>
            </computed-by>
            <stratify>
                <by name="gender">
                    <meta>
                        <annotation>
                            <div xmlns="http://www.w3.org/1999/xhtml">
                                <span>Stratified by gender</span>
                            </div>
                        </annotation>
                    </meta>

                    <identifier system="DHIS_INDICATORS" value="PATIENT:REGISTRATIONS:BY_GENDER" />
                    <select name="gender">gndr</select>
                    <thenBy name="age">
                        <identifier system="DHIS_INDICATORS"
                            value="PATIENT:REGISTRATIONS:BY_GENDER:BY_AGE" />
                        <select name="age">rg_name</select>
                    </thenBy>
                </by>
            </stratify>
        </add>
    </measures>
</BiIndicatorDefinition>