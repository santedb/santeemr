<div xmlns="http://www.w3.org/1999/xhtml" xmlns:sdb="http://santedb.org/applet" class="container-fluid p-0"
    oc-lazy-load="{ name: 'EmrPatientNextOfKinController', files: ['/org.santedb.emr/controllers/patient/widgets/nextOfKin.js'] }">
    <sdb:widget order="200" name="org.santedb.emr.widget.patient.nok" headerClass="alert-secondary" size="Large"
        type="Panel" context="org.santedb.emr.patient.view.demographics">
        <sdb:icon>fas fa-people-arrows</sdb:icon>
        <sdb:description lang="en">Patient Next of Kin</sdb:description>
        <sdb:demand>1.3.6.1.4.1.33349.3.1.5.9.2.2.3</sdb:demand>
        <sdb:views>
            <sdb:view type="Edit">
                <sdb:demand>1.3.6.1.4.1.33349.3.1.5.9.2.2.1</sdb:demand>
            </sdb:view>
        </sdb:views>
    </sdb:widget>

    <div ng-controller="EmrPatientNextOfKinController">
        <ul class="nav nav-tabs" role="tablist" id="demographicEditTabs">
            <li class="nav-item cursor-pointer" ng-if="panel.view != 'Edit'" ng-repeat="rel in relationships track by $index" role="presentation">
                <a data-target="#{{rel.relationshipTypeModel.mnemonic}}{{$index}}relative"
                    ng-class="{'active': $index == 0}" 
                    data-toggle="tab"
                    class="nav-link" >
                        <span ng-if="rel.relationshipTypeModel">
                            <i class="fa fa-user-friends"></i> 
                            <span ng-if="rel._inverse">
                                {{ 'ui.model.entityRelationship.inverse.prefix' | i18n }}
                            </span>

                            {{ rel.relationshipTypeModel | concept }}

                            <span ng-if="rel._inverse"> 
                                {{ 'ui.model.entityRelationship.inverse.suffix' | i18n }}
                            </span>
                            
                            <i class="fa fa-exclamation-triangle text-danger" ng-if="tabHasError('nok' + rel.id)"></i>
                        </span>
                </a>
            </li>

            <li class="nav-item cursor-pointer"  ng-if="panel.view == 'Edit'" ng-repeat="rel in editObject track by $index" role="presentation">
                <a data-target="#{{ getTabPaneId(rel, $index) }}"
                    ng-class="{'active': $index == 0}" 
                    data-toggle="tab"
                    class="nav-link" >
                        <span ng-if="rel.$id">
                            <i class="fa fa-exclamation-triangle text-danger mr-1" ng-if="tabHasError('nok' + rel.id)"></i>

                            <i class="fa fa-user-friends"></i> 

                            <span ng-if="rel._inverse">
                                {{ 'ui.model.entityRelationship.inverse.prefix' | i18n }}
                            </span>

                            {{ rel.relationshipTypeModel | concept }}
                            
                            <span ng-if="rel._inverse"> 
                                {{ 'ui.model.entityRelationship.inverse.suffix' | i18n }}
                            </span>
                        </span>
                        
                        <span ng-if="!rel.$id">
                            <i class="fa fa-exclamation-triangle text-danger" ng-if="tabHasError('nok' + rel.id)"></i>
                            
                            {{ 'ui.model.entityRelationship.new' | i18n }}

                            <i class="fa fa-times" ng-click="removeNewRelative(rel)"></i>
                        </span>
                </a>
            </li>

            <li class="active nav-item" role="presentation" ng-if="panel.view == 'Edit'">
                <a class="nav-link border-bottom-0 h-100" ng-click="addNewRelative()">
                    <i class="fa fa-plus mt-1"></i>
                </a>
            </li>
        </ul>

        <div class="tab-content" ng-if="panel.view != 'Edit'">
            <div role="tabpanel" class="tab-pane fade" id="{{ getTabPaneId(rel, $index) }}"
                ng-repeat="rel in relationships track by $index" ng-class="{'active show': $index == 0}">
                <div class="container mt-3">
                    <!-- #include virtual="~/views/patient/widgets/partials/nextOfKinView.html" -->
                </div>
            </div>
        </div>

        <form autocomplete="off" ng-if="panel.view == 'Edit'" name="panel.editForm" ng-submit="update(panel.editForm)" method="dialog" novalidate="novalidate">
            <div class="tab-content">
                <div role="tabpanel" class="tab-pane fade" id="{{ getTabPaneId(rel, $index) }}" ng-repeat="rel in editObject track by $index" ng-class="{'active show': $index == 0}">
                    <div class="container mt-3">
                        <div ng-if="!rel.$id" class="form-group row">
                            <label class="col-md-3 col-sm-12 control-label required">{{ 'ui.model.entity.relationship.relationshipType' | i18n }}</label>
                        
                            <div class="col-md-8 col-sm-12">
                                <concept-select ng-model="rel.relationshipType" 
                                    exclude-concepts="excludeRelationshipTypes"
                                    name="nok{{ rel.id }}relationshipType"
                                    ng-change="rel._active = true" 
                                    concept-set="'FamilyMember'"
                                    class="form-control" 
                                    required="required" />
                                
                                <div class="text-danger" ng-if="panel.editForm['nok' + rel.id + 'relationshipType'].$invalid">
                                    <i class="fas fa-exclamation-triangle"></i> {{ 'ui.error.required' | i18n }}
                                </div>
                            </div>
                        </div>

                        <!-- #include virtual="~/views/patient/widgets/partials/nextOfKinEdit.html" -->
                    </div>
                </div>

            </div>
        </form>
    </div>
</div>
